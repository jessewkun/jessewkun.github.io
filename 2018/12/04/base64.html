<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Golang 和 PHP 在 setcookie 时的微小差异 | 和歌的博客</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Golang 和 PHP 在 setcookie 时的微小差异</h1><a id="logo" href="/.">和歌的博客</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Golang 和 PHP 在 setcookie 时的微小差异</h1><div class="post-meta">Dec 4, 2018<span> | </span><span class="category"><a href="/categories/Golang/">Golang</a></span></div><div class="post-content"><pre><code>最近在做一个 Golang 的项目的时候，无意间了解到一些 PHP 和 Golang 的差异，以下为具体内容：
</code></pre><h4 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h4><p>​     在 PHP 的项目中，用户通过 sso 登录后把用户名通过 blowfish 算法加密后设置 cookie，每次请求均通过 cookie 获取到密文解密获得用户名并检查权限。项目在重构的时候选择了 Golang，但并不是完全替代 PHP，而是通过 nginx 把一部分请求转到 Golang 处理，其中就包括 sso 登录的部分，这就要求 Golang 设置的密文 cookie，可以被 PHP 解密并验证权限，但是在实际的测试中，却发现 PHP 无法解密。</p>
<p>​    以下对应的未解决问题前的 Golang 代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"crypto/cipher"</span></div><div class="line">	<span class="string">"encoding/base64"</span></div><div class="line"></div><div class="line">	<span class="string">"golang.org/x/crypto/blowfish"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	LOGIN_DES_KEY = <span class="string">"test1234"</span></div><div class="line">	LOGIN_DES_IV  = <span class="string">"12345678"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Decrypt</span><span class="params">(str <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	key := []<span class="keyword">byte</span>(DECRYPT_KEY)</div><div class="line">	IV := []<span class="keyword">byte</span>(DECRYPT_IV)</div><div class="line">	ci, _ := blowfish.NewCipher(key)</div><div class="line">	en := cipher.NewCBCDecrypter(ci, IV)</div><div class="line">	data, _ := base64.URLEncoding.DecodeString(str)</div><div class="line">        <span class="comment">// data, _ := base64.StdEncoding.DecodeString(str)</span></div><div class="line">	dst := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(data))</div><div class="line">	en.CryptBlocks(dst, data)</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(dst)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Encrypt</span><span class="params">(str <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	key := []<span class="keyword">byte</span>(DECRYPT_KEY)</div><div class="line">	IV := []<span class="keyword">byte</span>(DECRYPT_IV)</div><div class="line">	ci, _ := blowfish.NewCipher(key)</div><div class="line">	en := cipher.NewCBCEncrypter(ci, IV)</div><div class="line">	data := []<span class="keyword">byte</span>(str)</div><div class="line">	data = blowfishCheckSizeAndPad(data)</div><div class="line">	dst := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(data))</div><div class="line">	en.CryptBlocks(dst, data)</div><div class="line">	<span class="keyword">return</span> base64.URLEncoding.EncodeToString(dst)</div><div class="line">        <span class="comment">// return base64.StdEncoding.EncodeToString(dst)</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">blowfishCheckSizeAndPad</span><span class="params">(value []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	modulus := <span class="built_in">len</span>(value) % blowfish.BlockSize</div><div class="line">	<span class="keyword">if</span> modulus != <span class="number">0</span> &#123;</div><div class="line">		padnglen := blowfish.BlockSize - modulus</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; padnglen; i++ &#123;</div><div class="line">			value = <span class="built_in">append</span>(value, <span class="number">0</span>)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> value</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetCookie</span><span class="params">(name <span class="keyword">string</span>, w http.ResponseWriter)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	cookie := &amp;http.Cookie&#123;</div><div class="line">		Name:  <span class="string">"account"</span>,</div><div class="line">		Value: Encrypt(name),</div><div class="line">                <span class="comment">// Value: url.QueryEscape(Encrypt(name)),</span></div><div class="line">	&#125;</div><div class="line">	http.SetCookie(w, cookie)</div><div class="line">	<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​    以下对应的 PHP 代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line">define(<span class="string">'LOGIN_DES_KEY'</span>, <span class="string">'test1234'</span>);</div><div class="line">define(<span class="string">'LOGIN_DES_IV'</span>, <span class="string">'12345678'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span><span class="params">($value)</span></span></div><div class="line">&#123;</div><div class="line">    $cipher = mcrypt_module_open(MCRYPT_BLOWFISH, <span class="string">''</span>, <span class="string">'cbc'</span>, <span class="string">''</span>);</div><div class="line">    mcrypt_generic_init($cipher, LOGIN_DES_KEY, LOGIN_DES_IV);</div><div class="line">    $encrypted = mcrypt_generic($cipher, $value);</div><div class="line">    mcrypt_generic_deinit($cipher);</div><div class="line">    <span class="keyword">return</span> base64_encode($encrypted);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">decrypt</span><span class="params">($value)</span></span></div><div class="line">&#123;</div><div class="line">    $cipher = mcrypt_module_open(MCRYPT_BLOWFISH, <span class="string">''</span>, <span class="string">'cbc'</span>, <span class="string">''</span>);</div><div class="line">    mcrypt_generic_init($cipher, LOGIN_DES_KEY, LOGIN_DES_IV);</div><div class="line">    $decrypted = mdecrypt_generic($cipher, base64_decode($value));</div><div class="line">    mcrypt_generic_deinit($cipher);</div><div class="line">    <span class="keyword">return</span> rtrim($decrypted, <span class="string">"\0"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">setcookie(<span class="string">"account"</span>, encrypt(<span class="string">"admin"</span>), time() + <span class="number">86400</span>)</div></pre></td></tr></table></figure>
<h4 id="问题1："><a href="#问题1：" class="headerlink" title="问题1："></a>问题1：</h4><p>​    经过对比，发现同样的字符串通过这两段代码加密后的密文不一样：</p>
<p>PHP 输出：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$str = encrypt(<span class="string">'hello world'</span>);</div><div class="line"><span class="keyword">echo</span> $str; <span class="comment">// az2dmQEG+3vOXVQcmSJuxQ==</span></div><div class="line">$str2 = decrypt($str);</div><div class="line"><span class="keyword">echo</span> $str2; <span class="comment">// hello world</span></div></pre></td></tr></table></figure>
<p>Golang 输出：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">str := Encrypt(<span class="string">"hello world"</span>)</div><div class="line">fmt.Println(str) <span class="comment">// az2dmQEG-3vOXVQcmSJuxQ==</span></div><div class="line">str2 := Decrypt(str)</div><div class="line">fmt.Println(str2) <span class="comment">// hello world</span></div></pre></td></tr></table></figure>
<p>查看 Golang 的源码，发现用错了函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// StdEncoding is the standard base64 encoding, as defined in RFC 4648.</span></div><div class="line"><span class="keyword">var</span> StdEncoding = NewEncoding(encodeStd)</div><div class="line"></div><div class="line"><span class="comment">// URLEncoding is the alternate base64 encoding defined in RFC 4648.</span></div><div class="line"><span class="comment">// It is typically used in URLs and file names.</span></div><div class="line"><span class="keyword">var</span> URLEncoding = NewEncoding(encodeURL)</div></pre></td></tr></table></figure>
<p>​    修改为 StdEncoding 后加密的密文总算一样了。</p>
<h4 id="问题2："><a href="#问题2：" class="headerlink" title="问题2："></a>问题2：</h4><p>​    原以为问题就解决了，没想到 PHP 还是不能解密，取消 nginx 的转发，分别观察了两种语法的 setcookie，发现 http 请求中 setcookie 的密文居然不一样：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># Golang</div><div class="line">set-cookie: account=az2dmQEG+3vOXVQcmSJuxQ==</div><div class="line"></div><div class="line"># PHP</div><div class="line">set-cookie: account=az2dmQEG%2B3vOXVQcmSJuxQ%3D%3D</div></pre></td></tr></table></figure>
<p>​     可以看出，PHP 做了 urlencode 编码，但是在业务代码中并没有手动编码的操作，难道是 PHP 默认在 setcookie 的时候做了这个操作？<br>    下载 PHP 7.1.4 的源码，搜索 setcookie ，在 ext/standard/head.c 中发现了 setcookie 函数的定义，其内部实现中调用了函数 php_setcookie，并且倒数第二个参数默认为 1，而 php_setcookie 这个函数在参数 url_encode 为 1 的时候会进行 urlencode 操作，由此可以确定确实是 PHP 在 setcookie 的时候做了 urlencode 的操作：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">PHP_FUNCTION(setcookie)</div><div class="line">&#123;</div><div class="line">	zend_string *name, *value = <span class="literal">NULL</span>, *path = <span class="literal">NULL</span>, *domain = <span class="literal">NULL</span>;</div><div class="line">	zend_long expires = <span class="number">0</span>;</div><div class="line">	zend_bool secure = <span class="number">0</span>, httponly = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="comment">// ...</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> (php_setcookie(name, value, expires, path, domain, secure, <span class="number">1</span>, httponly) == SUCCESS) &#123;</div><div class="line">		RETVAL_TRUE;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		RETVAL_FALSE;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">PHPAPI <span class="keyword">int</span> <span class="title">php_setcookie</span><span class="params">(zend_string *name, zend_string *value, <span class="keyword">time_t</span> expires, zend_string *path, zend_string *domain, <span class="keyword">int</span> secure, <span class="keyword">int</span> url_encode, <span class="keyword">int</span> httponly)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// ...</span></div><div class="line"></div><div class="line">	len += ZSTR_LEN(name);</div><div class="line">	<span class="keyword">if</span> (value) &#123;</div><div class="line">		<span class="keyword">if</span> (url_encode) &#123;</div><div class="line">			encoded_value = php_url_encode(ZSTR_VAL(value), ZSTR_LEN(value));</div><div class="line">			len += ZSTR_LEN(encoded_value);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			encoded_value = zend_string_copy(value);</div><div class="line">			len += ZSTR_LEN(encoded_value);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​    修改 Golang 代码，在 setcookie 的时候做 url.QueryEscape() ，相对应的，在获取 cookie 的时候也需要做 url.QueryUnescape() 操作，这样一来，Golang 设置的密文 cookie 总算可以被 PHP 解密了。</p>
<h4 id="base64-和-urlencode7"><a href="#base64-和-urlencode7" class="headerlink" title="base64 和 urlencode7"></a>base64 和 urlencode7</h4><ol>
<li><p>base64 编码的数据可能会有 “+”</p>
</li>
<li><p>在 urlencode 中，”+” 是被空格编码出来的，在 base64 编码中则不是</p>
</li>
<li><p>PHP 在接收到请求解析 cookie 到 $_COOKIE 的时候会默认做 urldecode，所以未做 urlencode 的 base64_encode 过的数据有可能被解析错误</p>
</li>
</ol>
</div><div class="tags"><a href="/tags/Golang/">Golang</a><a href="/tags/PHP/">PHP</a></div><div class="post-nav"><a href="/2018/10/16/workflow.html" class="next">iOS 12 workflow 配合 AppleScript 实现 Mac 自动初始化</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://jessewkun.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node-js/">Node.js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Other/">Other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Tengine/" style="font-size: 15px;">Tengine</a> <a href="/tags/大数据/" style="font-size: 15px;">大数据</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/npm/" style="font-size: 15px;">npm</a> <a href="/tags/cnpm/" style="font-size: 15px;">cnpm</a> <a href="/tags/License/" style="font-size: 15px;">License</a> <a href="/tags/Golang/" style="font-size: 15px;">Golang</a> <a href="/tags/pm2/" style="font-size: 15px;">pm2</a> <a href="/tags/Vagrant/" style="font-size: 15px;">Vagrant</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/workflow/" style="font-size: 15px;">workflow</a> <a href="/tags/AppleScript/" style="font-size: 15px;">AppleScript</a> <a href="/tags/SSH/" style="font-size: 15px;">SSH</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/12/04/base64.html">Golang 和 PHP 在 setcookie 时的微小差异</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/16/workflow.html">iOS 12 workflow 配合 AppleScript 实现 Mac 自动初始化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/13/phparray.html">PHP 数组</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/08/phpvariable.html">PHP 变量作用域</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/08/cnpm.html">私有 npm 仓库的搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/26/bigdata.html">大数据常见概念简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/19/license.html">常见开源协议的区别</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/08/vagrant.html">Vagrant 的简介和基础使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/08/node env.html">Node 生产环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/13/redis.html">Redis 学习笔记</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">和歌的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>