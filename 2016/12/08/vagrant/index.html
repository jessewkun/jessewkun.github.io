<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Vagrant 的简介和基础使用 | 和歌的博客</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">和歌的博客</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Vagrant 的简介和基础使用</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-12-08</div><div class="post-tags"><a class="post-tag-link" href="/tags/Vagrant/">Vagrant</a></div></div></div><article><div class="container post"><p>Vagrant 实际上一套虚拟机管理工具，基于 Ruby 开发，底层支持 VirtualBox、VMware 甚至 AWS、Docker 等作为虚拟化系统。我们可以通过 Vagrant 封装一个 Linux 的开发环境，分发给团队成员。成员可以在自己喜欢的桌面系统（Mac/Windows/Linux）上开发程序，代码却能统一在封装好的环境里运行，“代码在我机子上运行没有问题”这种说法将成为历史。</p>
<p>Vagrant 本身并没有能力创建虚拟机，它是调用一些虚拟化工具来创建，如 VirtualBox,VMWare，甚至 AWS</p>
<h2 id="box"><a href="#box" class="headerlink" title="box"></a>box</h2><ol>
<li><p>可被<code>Vagrant</code>直接使用的虚拟机镜像文件</p>
</li>
<li><p>基于不同虚拟化技术打包的<code>box</code>是不一样的</p>
</li>
<li><p><a href="http://www.vagrantbox.es/" title="vagrantbox" target="_blank" rel="external">http://www.vagrantbox.es</a></p>
</li>
</ol>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><strong>vagrant</strong> 支持在线安装，但是鉴于 <code>GFW</code> 的原因，国内用户使用的时候最好先在 <a href="http://www.vagrantbox.es/" title="vagrantbox" target="_blank" rel="external">http://www.vagrantbox.es</a> 下载好要使用的 <code>box</code>在本地安装</p>
<p>vagrant box 放在/Users/wangkun/Downloads/precise64.box</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mkdir vagrant &amp;&amp; cd vagrant</div><div class="line">vagrant -v</div><div class="line">vagrant box add base /Users/wangkun/Downloads/precise64.box</div><div class="line">vagrant init (boxname)</div></pre></td></tr></table></figure>
<p><code>base</code>是<code>box</code>的名称，可以是任意的字符串，<code>base</code>是默认名称，主要用来标识一下你添加的<code>box</code>，后面的命令都是基于这个标识来操作的。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim Vagrnatfile</div></pre></td></tr></table></figure>
<h4 id="网络模式"><a href="#网络模式" class="headerlink" title="网络模式"></a>网络模式</h4><ul>
<li><p><strong>端口映射</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">config.vm.network “forwarded_port&quot;, guest: 80, host: 8080</div><div class="line">guest: 80 表示虚拟机中的80端口， host: 8080 表示映射到宿主机的8080端口</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p><strong>私有网络</strong>（等效于设置virtualbox使用host-only模式网络适配器），自己自由的访问虚拟机，但是别人不需要访问虚拟机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">config.vm.network “private_network&quot;, ip: &quot;192.168.33.10&quot;</div><div class="line">192.168.33.10 表示虚拟机的IP，多台虚拟机的话需要互相访问的话，设置在相同网段即可</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p><strong>公有网络</strong>（等效于设置virtualbox使用bridged模式网络适配器），如果需要将虚拟机作为当前局域网中的一台计算机，由局域网进行DHCP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">config.vm.network “public_network&quot;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="目录映射"><a href="#目录映射" class="headerlink" title="目录映射"></a>目录映射</h4><p>将本地的目录映射到虚拟机的对应目录,可以同时映射多个目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">config.vm.synced_folder &quot;/Users/wangkun/www&quot;, &quot;/vagrant_data&quot;</div></pre></td></tr></table></figure>
<p>前边的参数是本地目录，后边是映射目录</p>
<p>系统会自动映射宿主机当前目录到虚拟机根目录的 <code>/vagrant</code></p>
<blockquote>
<p>在该虚拟机上进行<code>rm -rf</code>操作的时候请谨慎一些，因为在虚拟机中最少也会挂载/vagrant目录，该目录是与你主机的项目共享的，删除的话会将项目删除掉。</p>
</blockquote>
<h4 id="启动脚本（非必须）"><a href="#启动脚本（非必须）" class="headerlink" title="启动脚本（非必须）"></a>启动脚本（非必须）</h4><p>如果有需要在启动时运行一些脚本，可以编辑脚本，类似如下（摘自Vagrant Document）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env bash</div><div class="line">apt-get update</div><div class="line">apt-get install -y apache2</div><div class="line">rm -rf /var/www</div><div class="line">ln -fs /vagrant /var/www</div></pre></td></tr></table></figure>
<p>保存在和<code>Vagrantfile</code>相同目录，文件名自取（如 <code>boot.sh</code>），然后在<code>Vagrantfile</code>中添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">config.vm.provision :shell, :path =&gt; &quot;boot.sh&quot;</div></pre></td></tr></table></figure>
<h4 id="其他设置"><a href="#其他设置" class="headerlink" title="其他设置"></a>其他设置</h4><p>设定VM的名称和内存大小等等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">config.vm.provider &quot;virtualbox&quot; do |vb|</div><div class="line">  vb.customize [&quot;modifyvm&quot;, :id,</div><div class="line">                &quot;--name&quot;, &quot;dev&quot;,</div><div class="line">                &quot;--cpus&quot;, &quot;1&quot;,</div><div class="line">                &quot;--memory&quot;, &quot;512&quot;]</div><div class="line">end</div></pre></td></tr></table></figure>
<p>这行设置的意思是调用<code>VBoxManage</code>的<code>modifyvm</code>的命令，设置<code>VM</code>的名称为<code>dev</code>，<code>cpu</code>为1个核心，内存为512MB。你可以类似的通过定制其它<code>VM</code>属性来定制你自己的<code>VM</code></p>
<h2 id="启动并使用"><a href="#启动并使用" class="headerlink" title="启动并使用"></a>启动并使用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vagrant up</div><div class="line">vagrant ssh</div></pre></td></tr></table></figure>
<p><code>os x</code> 和 <code>linux</code> 下可以直接使用这个命令登录，<code>windows</code>下需要第三方软件支持，<code>win10</code>正式版<code>PowerShell</code>也将支持 <code>SSH</code></p>
<h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">vagrant up （启动虚拟机）</div><div class="line">vagrant halt （关闭虚拟机——对应就是关机）</div><div class="line">vagrant reload (重新加载配置文件并启动，不会执行启动脚本)</div><div class="line">vagrant reload --provision (重新加载配置文件并启动，强制执行启动脚本)</div><div class="line">vagrant suspend （暂停虚拟机——只是暂停，虚拟机内存等信息将以状态文件的方式保存在本地，可以执行恢复操作后继续使用）</div><div class="line">vagrant resume （恢复虚拟机 —— 与前面的暂停相对应）</div><div class="line">vagrant destroy （删除虚拟机，删除后在当前虚拟机所做进行的除Vagrantfile中的配置都不会保留）</div><div class="line">vagrant global-status  (可以看到虚拟机的状态，这个状态是被缓存起来的，可能不一定准确)</div><div class="line">vagrant global-status --prune  (刷新状态)</div><div class="line">vagrant box list   (显示box列表)</div></pre></td></tr></table></figure>
<h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vagrant package --output NAME --vagrantfile FILE</div></pre></td></tr></table></figure>
<p>可选参数:  </p>
<p>–output NAME ： （可选）设置通过NAME来指定输出的文件名  </p>
<p>–vagrantfile FILE：（可选）可以将Vagrantfile直接封进box中  </p>
<p>注：如果网络模式中使用 private_network 的话，在打包之前需要清除一下private_network的设置，避免不必要的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo rm -f /etc/udev/rule.d/70-persistent-net.rules</div></pre></td></tr></table></figure>
<p>制作完成之后直接将<code>box</code>文件拿到其他计算机上配置即可使用。</p>
<h4 id="多个VM的配置和启动"><a href="#多个VM的配置和启动" class="headerlink" title="多个VM的配置和启动"></a>多个VM的配置和启动</h4><p><code>vagrant</code>支持在一个<code>Vagrantfile</code>中配置多个<code>VM</code></p>
<p><strong>单Vagrantfile</strong></p>
<ul>
<li>各个<code>VM</code>的配置和启动都相对独立，如<code>vagrant ssh</code>时可不指定<code>VM</code>名。</li>
<li><code>Vagrantfile</code>也不至于常常要改</li>
</ul>
<p><strong>多Vagrantfile</strong></p>
<ul>
<li>一个<code>Vagrantfile</code>收录了整个大环境中所有<code>VM</code>的基本配置，一眼就知道环境里共有哪些<code>VM</code>，也不需要切换目录来检查各<code>VM</code>的状态，跟不会搞混了目录“丢掉”哪个倒霉的<code>VM</code>。</li>
<li>更多地使用<code>Chef/Puppet</code>来配置各<code>VM</code>，比如把<code>VM</code>的<code>ip</code>配置从<code>Vagrantfile</code>后推到<code>puppet</code>进行，保持<code>Vagrantfile</code>的简洁。目的是在对本地环境的<code>VM</code>配置,甚至生产环境的节点配置上，保持较高的一致性，有利于统一部署方式。</li>
</ul>
<h4 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h4><ol>
<li><p><code>vagrant</code>启动报错的时候尝试用<code>VirtualBox</code>启动,可能会直接弹出<code>VT-x is disabled in the BIOS. (VERR_VMX_MSR_VMXON_DISABLED)</code>这个错误，这是因为没有开启宿主机的虚拟化，重启宿主机进入<code>bios</code>，开启<code>virtualiation</code>选项即可</p>
</li>
<li><p><code>HTTP</code>服务器静态资源缓存问题，这个我没遇到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//nginx</div><div class="line">sendfile off;</div><div class="line">   </div><div class="line">//apache</div><div class="line">EnableSendfile off</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>vagrant默认启动超时时间是300S，如果启动超时可以配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">config.vm.boot_timeout = 1000</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="vagrant-和-docker-的区别"><a href="#vagrant-和-docker-的区别" class="headerlink" title="vagrant 和 docker 的区别"></a>vagrant 和 docker 的区别</h4><h5 id="vagrant"><a href="#vagrant" class="headerlink" title="vagrant"></a>vagrant</h5><ul>
<li>vagrant 用来构建并运行基于 lxc(内核虚拟化技术) 的虚拟 Linux 容器 </li>
<li>易于配置、可量产、并且可移植的工作环境，并且由一个统一的工作流程进行控制</li>
<li>在硬件级别分配资源，支持部署 Linux，Unix，Windows</li>
<li>启动较 docker 稍慢一些</li>
<li>有点笨重，但是仍然比完整的虚拟机来得好，其他有点：同时支持和一些配置工具（如Puppet，Chef）集成</li>
</ul>
<h5 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h5><ul>
<li>Docker 基于Linux虚拟机的虚拟环境（Virtual Environment）工具。</li>
<li>在软件级别分配资源，支持部署 Linux，Unix，Windows</li>
<li>启动只需几秒钟,所创建的虚拟机的隔离级别和安全性：部分</li>
<li>轻量级，其他有点：快速，易于学习</li>
<li>Vagrant现在也具有一个Docker提供商，因此您可以用vagrant来管理Docker的构建和部署</li>
</ul>
<h5 id="作者怎么说？"><a href="#作者怎么说？" class="headerlink" title="作者怎么说？"></a>作者怎么说？</h5><ul>
<li><a href="http://www.linuxidc.com/Linux/2014-09/106783.htm" title="中文版" target="_blank" rel="external">http://www.linuxidc.com/Linux/2014-09/106783.htm</a></li>
<li><a href="http://stackoverflow.com/questions/16647069/should-i-use-vagrant-or-docker-io-for-creating-an-isolated-environment" title="英文版" target="_blank" rel="external">http://stackoverflow.com/questions/16647069/should-i-use-vagrant-or-docker-io-for-creating-an-isolated-environment</a></li>
</ul>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">Jesse wkun</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>